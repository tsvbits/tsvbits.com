---
title: How did we make Flash Viewer at ActiveReports
date: '2019-08-11'
spoiler: Open sourcing PageFX compiler
---

__TL;DR__ GrapeCity opens compiler used to build ActiveReports Flash Viewer

It was not easy path. First we implemented a cross compiler from [.NET](https://en.wikipedia.org/wiki/Common_Intermediate_Language) to [Flash Player](https://www.adobe.com/content/dam/acom/en/devnet/pdf/avm2overview.pdf) byte code.

And this post is about this cross compiling tool.
It was called [PageFX](https://github.com/GrapeCity/pagefx) later also called PFX.

## History

I started this project in June of 2007 by invitation from [Scott Willeke](https://scott.willeke.com/). Initial idea of guys from [Data Dynamics](https://en.wikipedia.org/wiki/Data_Dynamics) was to create a multi-platform WPF implementation for building rich internet applications using Adobe Flash Player. Flash Player was selected before Microsoft presented [Silverlight](https://www.microsoft.com/silverlight/).

First prototype was implemented by Ferhat Buyukkokten (VP Development). He made initial proof of concept of PFX compiler with implementation of most of WPF visual elements. 

Also on that time Flash was popular and there were millions of flash resources on the internet (games, ads, etc). Silverlight was passing first baby-born steps. And for DD flash looked as promissing technology.

After three monthes unsuccessfull attempt to implement a real-world app on top of PageFX I convinced Scott to rewrite the compiler from scratch having only the following as basis:
- [.NET CLI ECMA-335 spec](https://www.ecma-international.org/publications/files/ECMA-ST/ECMA-335.pdf) - this doc describes format of .NET executable files
- [AVM overview doc](https://www.adobe.com/content/dam/acom/en/devnet/pdf/avm2overview.pdf) - this doc describes format of byte code parsed and executed by ActionScript Virtual Machine
- [AVM source code](https://github.com/adobe/avmplus) - initial version was hosted at [Mozilla](https://hg.mozilla.org/tamarin-central)
- also I've showed CIL, SWF, ABC readers I've done so far as artifact of my learning CIL and ABC executable file formats

I made few major iterations to make the compiler.
First iteration was not successful though a lot of test cases worked. I've tried to build .NET decompiler first and then translate it to AVM byte code.
I don't remember why I've decided to deny approach with decompiler, but idea with binary translation won and I've quickly implemented first prototype.

Then it took about 6 months to get working a lot of [Mono](https://www.mono-project.com/) tests for byte code generated by C# 2.0 (CLR 1.0 byte code) without generics.

First good application of PFX compiler was built by [Oleg Zaimkin](https://twitter.com/olegzeee). Initial prototype was hacked by Oleg in July 2008 in few weeks during his vacation.

In July-August 2008 [Yuri Kashnikov](https://twitter.com/kayuri) joined me to help me with the project. Together we implemented a lot of things:
- Almost full support of CLR 2.0 byte code format including generics
- Interop with libraries built by ActionScript compiler (ASC)
- Debugger for Visual Studio 2008

In Jan 2009 the project was closed. Actually active development was stopped but it was still used to compile Flash Viewer for Active Reports. And it was released that year. Note Adobe was not interested to evolve this project.

I've joined [Data Dynamics Reports](https://www.componentsource.com/product/data-dynamics-reports) dev team to build Flash Viewer for our new reporting system.

## Going open source

I think this project might be interesting for education purposes for Microsoft Research students or any other universities.

BTW in 2009 I've made an experimental branch with a lot of interesting changes but they probably are not stable since not used in production:

- I've made PFX compiler to be cross-platform/runnable on Mono VM and compatible with Mono C# compiler
- Reuse of Mono MDB reader, i.e. managed reader of debug symbols. Previously we use COM library runnable only on Windows
- Multi-targeting on Flash Player 9.0 and higher, i.e. Flash APIs are declared in separate assemblies auto-generated as part of build process
- Multi-targeting on Flex SDK 3.3 and higher. Interop assemblies for Flex SDK are also auto-generated
- Faster lazy parsing of assemblies into immutable data structures with less memory consumption

Also master branch includes interesting experiments:
- JavaScript code generation (a lot of tests were passing)
- CIL interpreter written in pure C# on top of PFX infrastructure
- Port of [Starling game engine](https://gamua.com/starling/)

You might also find interesting [this old project](https://github.com/sergeyt/cil.js) available on github.
It has declarative [CIL reader](https://github.com/sergeyt/cil.js/blob/master/src/runtime/meta.js) written in JavaScript.
This could be a starting point for full CIL interpreter in JavaScript.

If someone interested to get more details about PageFX project please [email me](mailto:stodyshev@gmail.com).
I can write a series of blog posts perhaps someone may find it interesting.

## Funny fact

PFX compiler was used almost ten years without any fixes to build Flash Viewer until drop of its support. I know it had bugs, but it was enough for Flash Viewer

P.S. All dates might be a little bit wrong. Sorry for that)
